name: HIL Timebase

on:
  workflow_dispatch:
    inputs:
      uart_port:
        description: "UART device path"
        required: true
        default: "/dev/ttyACM0"
      duration_sec:
        description: "Test in sec"
        required: true
        default: "60"
      firmware_role:
        description: "Firmware role to flash"
        required: true
        default: "master"
        type: choice
        options:
          - master
          - slave

jobs:
  hil:
    runs-on: [self-hosted, Linux, stm32-hil]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Pythondeps
        run: |
          python3 -m venv .venv
          .venv/bin/python -m pip install --upgrade pip
          .venv/bin/python -m pip install pyserial
      
      - name: Build debug test
        run: ./scripts/build_debug_tests.sh

      - name: Flash
        run: |
            st-info --probe
            st-flash --connect-under-reset write "stm32/app/buildD/app_${{ github.event.inputs.firmware_role }}.bin" 0x08000000

      - name: UART connect
        run: |
          .venv/bin/python scripts/hil_check_timebase.py \
            --port "${{ github.event.inputs.uart_port }}" \
            --duration "${{ github.event.inputs.duration_sec }}"