name: HIL Timebase

on:
  workflow_dispatch:
    inputs:
      uart_port:
        description: "UART device path"
        required: true
        default: "/dev/ttyACM0"
      duration_sec:
        description: "Test in sec"
        required: true
        default: "60"
      build_type:
        description: "Build type"
        required: true
        type: choice
        default: "debug"
        options: [debug, release]
      firmware_role:
        description: "Firmware role"
        required: true
        type: choice
        default: "master"
        options: [master, slave]

jobs:
  hil:
    runs-on: [self-hosted, Linux, stm32-hil]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Pythondeps
        run: |
          python3 -m venv .venv
          .venv/bin/python -m pip install --upgrade pip
          .venv/bin/python -m pip install pyserial
      
      - name: Build debug test
        if: ${{ github.event.inputs.build_type == 'debug' }}
        run: ./scripts/build_debug_tests.sh

      - name: Build release
        if: ${{ github.event.inputs.build_type == 'release' }}
        run: ./scripts/build_relase.sh

      - name: Flash selected firmware
        run: |
          if [ "${{ github.event.inputs.build_type }}" = "debug" ]; then
            BUILD_DIR="buildD"
          else
            BUILD_DIR="buildR"
          fi
          st-info --probe
          st-flash --connect-under-reset write "stm32/app/${BUILD_DIR}/app_${{ github.event.inputs.firmware_role }}.bin" 0x08000000

      - name: UART timebase check (debug only)
        if: ${{ github.event.inputs.build_type == 'debug' }}
        run: |
          .venv/bin/python scripts/hil_check_timebase.py \
            --port "${{ github.event.inputs.uart_port }}" \
            --duration "${{ github.event.inputs.duration_sec }}"