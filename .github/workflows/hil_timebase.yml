name: HIL Timebase

on:
  workflow_dispatch:
        inputs:
          duration_phase1:
            description: "Phase 1 timebase duration (sec)"
            required: true
            default: "60"
          duration_phase2:
            description: "Phase 2 timestamps duration (sec)"
            required: true
            default: "15"
          duration_phase3:
            description: "Phase 3 link duration (sec)"
            required: true
            default: "10"

jobs:
  hil:
    runs-on: [self-hosted, Linux, stm32-hil]

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Python deps
        run: |
          python3 -m venv .venv
          .venv/bin/python -m pip install --upgrade pip
          .venv/bin/python -m pip install pyserial

      - name: Build debug tests
        run: ./scripts/build_debug_tests.sh

      - name: Resolve both targets automatically (serial + UART)
        id: target
        shell: bash
        env:
          VAR_MASTER_SERIAL: ${{ vars.STLINK_MASTER_SERIAL }}
          VAR_SLAVE_SERIAL: ${{ vars.STLINK_SLAVE_SERIAL }}

          DEFAULT_MASTER_SERIAL: "066FFF575256867067032707"
          DEFAULT_SLAVE_SERIAL: "066FFF555071494867024950"
        run: |
          set -euo pipefail

            MASTER_SERIAL="${VAR_MASTER_SERIAL:-$DEFAULT_MASTER_SERIAL}"
            SLAVE_SERIAL="${VAR_SLAVE_SERIAL:-$DEFAULT_SLAVE_SERIAL}"

          resolve_uart_from_serial() {
            local serial="$1"
            local p

            # 1) Prefer stable links
            shopt -s nullglob
            for p in /dev/serial/by-id/*"${serial}"*if02* /dev/serial/by-id/*"${serial}"*if00* /dev/serial/by-id/*"${serial}"*; do
              if [ -e "$p" ]; then
                readlink -f "$p"
                shopt -u nullglob
                return 0
              fi
            done
            shopt -u nullglob

            # 2) Fallback: scan tty devices via udev
            local dev props short ifnum
            local best_dev=""
            local best_prio=999
            local prio=999

            for dev in /dev/ttyACM* /dev/ttyUSB*; do
              [ -e "$dev" ] || continue
              props="$(udevadm info -q property -n "$dev" || true)"
              short="$(printf '%s\n' "$props" | sed -n 's/^ID_SERIAL_SHORT=//p' | sed -n '1p')"
              [ "$short" = "$serial" ] || continue

              ifnum="$(printf '%s\n' "$props" | sed -n 's/^ID_USB_INTERFACE_NUM=//p' | sed -n '1p')"

              # prefer: if02 > if00 > any
              prio=50
              [ "$ifnum" = "02" ] && prio=0
              [ "$ifnum" = "00" ] && prio=10

              if [ "$prio" -lt "$best_prio" ]; then
                best_prio="$prio"
                best_dev="$dev"
              fi
            done

            [ -n "$best_dev" ] || return 1
            echo "$best_dev"
          }

          UART_MASTER="$(resolve_uart_from_serial "$MASTER_SERIAL")" || {
            echo "Cannot resolve UART for master ST-Link serial: $MASTER_SERIAL"
            ls -la /dev/serial/by-id || true
            exit 1
          }
          UART_SLAVE="$(resolve_uart_from_serial "$SLAVE_SERIAL")" || {
            echo "Cannot resolve UART for slave ST-Link serial: $SLAVE_SERIAL"
            ls -la /dev/serial/by-id || true
            exit 1
          }

          echo "stlink_master=$MASTER_SERIAL" >> "$GITHUB_OUTPUT"
          echo "uart_master=$UART_MASTER" >> "$GITHUB_OUTPUT"
          echo "stlink_slave=$SLAVE_SERIAL" >> "$GITHUB_OUTPUT"
          echo "uart_slave=$UART_SLAVE" >> "$GITHUB_OUTPUT"

          echo "Master ST-Link: $MASTER_SERIAL -> UART: $UART_MASTER"
          echo "Slave ST-Link: $SLAVE_SERIAL -> UART: $UART_SLAVE"

      - name: Flash master and slave
        env:
          STLINK_MASTER: ${{ steps.target.outputs.stlink_master }}
          STLINK_SLAVE: ${{ steps.target.outputs.stlink_slave }}
        run: |
          set -euo pipefail
          st-info --probe
          for role in master slave; do
            serial_var="STLINK_$(echo "$role" | tr 'a-z' 'A-Z')"
            serial="${!serial_var}"
            echo "Flashing $role..."
            st-flash --serial "$serial" --connect-under-reset \
              write "stm32/app/buildD/app_${role}.bin" 0x08000000
            sleep 3
          done

      - name: UART M1 check master
        run: |
          .venv/bin/python scripts/hil_check_M1.py \
            --role master \
            --port "${{ steps.target.outputs.uart_master }}" \
            --duration-phase1 "${{ github.event.inputs.duration_phase1 }}" \
            --duration-phase2 "${{ github.event.inputs.duration_phase2 }}" \
            --duration-phase3 "${{ github.event.inputs.duration_phase3 }}"

      - name: UART M1 check slave
        run: |
          .venv/bin/python scripts/hil_check_M1.py \
            --role slave \
            --port "${{ steps.target.outputs.uart_slave }}" \
            --duration-phase1 "${{ github.event.inputs.duration_phase1 }}" \
            --duration-phase2 "${{ github.event.inputs.duration_phase2 }}" \
            --duration-phase3 "${{ github.event.inputs.duration_phase3 }}"